{% extends 'base.html' %}

{% block title %}Create Build - NoHands{% endblock %}

{% block content %}
<div class="page-header d-print-none">
    <div class="row align-items-center">
        <div class="col">
            <h2 class="page-title">
                <i class="ti ti-rocket me-2"></i>
                Create New Build
            </h2>
        </div>
    </div>
</div>

<div class="row row-cards mt-3">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Commit Information</h3>
            </div>
            <div class="card-body">
                <div class="datagrid">
                    <div class="datagrid-item">
                        <div class="datagrid-title">Repository</div>
                        <div class="datagrid-content">
                            <i class="ti ti-folder text-muted me-1"></i>
                            {{ repository.name }}
                        </div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Commit SHA</div>
                        <div class="datagrid-content">
                            <code>{{ commit.sha }}</code>
                        </div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Commit Message</div>
                        <div class="datagrid-content">{{ commit.message }}</div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Author</div>
                        <div class="datagrid-content">
                            <i class="ti ti-user text-muted me-1"></i>
                            {{ commit.author }}
                        </div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Date</div>
                        <div class="datagrid-content">
                            <i class="ti ti-clock text-muted me-1"></i>
                            {{ commit.committed_at|date:"Y-m-d H:i:s" }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-file-code me-2"></i>
                    Dockerfile Configuration
                </h3>
            </div>
            <div class="card-body">
                <form method="post" id="build-form">
                    {% csrf_token %}
                    
                    <!-- Dockerfile Source Selection -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Dockerfile Source</strong></label>
                        <div class="form-selectgroup">
                            <label class="form-selectgroup-item">
                                <input type="radio" name="dockerfile_source" value="generated" class="form-selectgroup-input" checked>
                                <span class="form-selectgroup-label">
                                    <i class="ti ti-wand me-1"></i>
                                    Template
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="dockerfile_source" value="custom" class="form-selectgroup-input">
                                <span class="form-selectgroup-label">
                                    <i class="ti ti-edit me-1"></i>
                                    Custom Content
                                </span>
                            </label>
                            <label class="form-selectgroup-item">
                                <input type="radio" name="dockerfile_source" value="repo_file" class="form-selectgroup-input">
                                <span class="form-selectgroup-label">
                                    <i class="ti ti-file me-1"></i>
                                    File from Repo
                                </span>
                            </label>
                        </div>
                        <small class="form-hint">
                            Choose how to provide the Dockerfile for this build.
                        </small>
                    </div>
                    
                    <!-- Template Selection Dropdown -->
                    <div class="mb-3" id="template-selection-section">
                        <label class="form-label" for="dockerfile_template">
                            <strong>Select Template</strong>
                        </label>
                        <select class="form-select" id="dockerfile_template" name="dockerfile_template">
                            {% for name, content in dockerfile_templates.items %}
                            <option value="{{ name }}" {% if name == "Python" %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-hint">
                            Select a pre-made Dockerfile template for your application type.
                        </small>
                    </div>
                    
                    <!-- Dockerfile Content Editor -->
                    <div class="mb-3" id="dockerfile-content-section">
                        <label class="form-label" for="dockerfile_content">
                            <strong>Dockerfile Content</strong>
                        </label>
                        <textarea class="form-control" id="dockerfile_content" name="dockerfile_content" 
                                  rows="15" style="font-family: monospace; font-size: 0.875rem;">{{ default_dockerfile }}</textarea>
                        <small class="form-hint">
                            Edit the Dockerfile content for this build. This content will be used to build the Docker image.
                        </small>
                    </div>
                    
                    <!-- File Selector from Repository -->
                    <div class="mb-3" id="dockerfile-file-section" style="display: none;">
                        <label class="form-label"><strong>Select Dockerfile from Repository</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="dockerfile_path" name="dockerfile_path" 
                                   value="Dockerfile" placeholder="Path to Dockerfile" readonly>
                            <button type="button" class="btn btn-outline-primary" id="browse-files-btn">
                                <i class="ti ti-folder-open me-1"></i>
                                Browse Files
                            </button>
                        </div>
                        <small class="form-hint">
                            Select a file from the repository to use as the Dockerfile.
                        </small>
                        
                        <!-- File Preview -->
                        <div id="file-preview-section" class="mt-2" style="display: none;">
                            <label class="form-label">File Preview</label>
                            <pre class="logs" id="file-preview" style="max-height: 200px; overflow-y: auto;">Loading...</pre>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Environment Variables Section -->
                    <div class="mb-3" id="env-content-section">
                        <label class="form-label" for="env_content">
                            <strong><i class="ti ti-file-text me-1"></i>Environment Variables (.env)</strong>
                        </label>
                        <textarea class="form-control" id="env_content" name="env_content" 
                                  rows="8" style="font-family: monospace; font-size: 0.875rem;">{{ default_env }}</textarea>
                        <small class="form-hint">
                            Define environment variables for this build. These will be written to a .env file in the build context.
                            The .env content is specific to this build and does not affect the template.
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Container Port -->
                    <div class="mb-3">
                        <label class="form-label" for="container_port">
                            <strong>Container Port</strong>
                        </label>
                        <input type="number" class="form-control" id="container_port" name="container_port" 
                               value="8080" min="1" max="65535" placeholder="8080">
                        <small class="form-hint">
                            The port exposed by the application inside the container. This port will be mapped to an available host port when running the container.
                        </small>
                    </div>
                    
                    <!-- Push to Registry -->
                    <div class="mb-3">
                        <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="push_to_registry">
                            <span class="form-check-label">
                                <strong>Push to Docker Registry</strong>
                                <span class="form-check-description">
                                    Push the built image to the configured Docker registry after successful build
                                </span>
                            </span>
                        </label>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-success">
                            <i class="ti ti-rocket"></i>
                            Start Build
                        </button>
                        <a href="{% url 'repository_detail' repository.id %}" class="btn btn-secondary ms-2">
                            <i class="ti ti-x"></i>
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-info-circle me-2"></i>
                    About Builds
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    This will create a new Docker build using Dagger for the selected commit.
                </p>
                <div class="list-group list-group-flush">
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="badge bg-blue text-white"></span>
                            </div>
                            <div class="col text-truncate">
                                <div class="text-reset d-block">Flexible Dockerfile</div>
                                <div class="d-block text-muted text-truncate mt-n1">Use templates or your own</div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="badge bg-green text-white"></span>
                            </div>
                            <div class="col text-truncate">
                                <div class="text-reset d-block">Tags with commit SHA</div>
                                <div class="d-block text-muted text-truncate mt-n1">Easy to track and rollback</div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="badge bg-purple text-white"></span>
                            </div>
                            <div class="col text-truncate">
                                <div class="text-reset d-block">Run container after build</div>
                                <div class="d-block text-muted text-truncate mt-n1">Access your app via URL</div>
                            </div>
                        </div>
                    </div>
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="badge bg-orange text-white"></span>
                            </div>
                            <div class="col text-truncate">
                                <div class="text-reset d-block">View real-time logs</div>
                                <div class="d-block text-muted text-truncate mt-n1">Monitor container output</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Available Templates Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="ti ti-template me-2"></i>
                    Available Templates
                </h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-2">
                    Pre-configured Dockerfile templates:
                </p>
                <div class="list-group list-group-flush">
                    {% for name, content in dockerfile_templates.items %}
                    <div class="list-group-item d-flex align-items-center">
                        <i class="ti ti-file-code text-muted me-2"></i>
                        <span>{{ name }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Browser Modal -->
<div class="modal modal-blur fade" id="file-browser-modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="ti ti-folder-open me-2"></i>
                    Select File from Repository
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="ti ti-search"></i>
                        </span>
                        <input type="text" class="form-control" id="file-search" placeholder="Search files...">
                    </div>
                </div>
                <div id="file-list" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="mt-2 text-muted">Loading files...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dockerfileSourceInputs = document.querySelectorAll('input[name="dockerfile_source"]');
    const dockerfileContentSection = document.getElementById('dockerfile-content-section');
    const dockerfileFileSection = document.getElementById('dockerfile-file-section');
    const templateSelectionSection = document.getElementById('template-selection-section');
    const templateSelect = document.getElementById('dockerfile_template');
    const dockerfileContentTextarea = document.getElementById('dockerfile_content');
    const envContentTextarea = document.getElementById('env_content');
    const browseFilesBtn = document.getElementById('browse-files-btn');
    const fileBrowserModal = new bootstrap.Modal(document.getElementById('file-browser-modal'));
    const fileListEl = document.getElementById('file-list');
    const fileSearchEl = document.getElementById('file-search');
    const dockerfilePathInput = document.getElementById('dockerfile_path');
    const filePreviewSection = document.getElementById('file-preview-section');
    const filePreviewEl = document.getElementById('file-preview');
    
    let allFiles = [];
    
    // Handle dockerfile source change
    dockerfileSourceInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'repo_file') {
                dockerfileContentSection.style.display = 'none';
                dockerfileFileSection.style.display = 'block';
                templateSelectionSection.style.display = 'none';
            } else if (this.value === 'generated') {
                dockerfileContentSection.style.display = 'block';
                dockerfileFileSection.style.display = 'none';
                templateSelectionSection.style.display = 'block';
            } else {
                // custom
                dockerfileContentSection.style.display = 'block';
                dockerfileFileSection.style.display = 'none';
                templateSelectionSection.style.display = 'none';
            }
        });
    });
    
    // Handle template selection change - load both Dockerfile and .env templates
    templateSelect.addEventListener('change', function() {
        const templateName = this.value;
        loadDockerfileTemplate(templateName);
        loadEnvTemplate(templateName);
    });
    
    function loadDockerfileTemplate(templateName) {
        fetch(`/builds/api/templates/${encodeURIComponent(templateName)}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dockerfileContentTextarea.value = data.content;
                }
            })
            .catch(error => {
                console.error('Error loading Dockerfile template:', error);
            });
    }
    
    function loadEnvTemplate(templateName) {
        fetch(`/builds/api/env-templates/${encodeURIComponent(templateName)}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    envContentTextarea.value = data.content;
                }
            })
            .catch(error => {
                console.error('Error loading .env template:', error);
            });
    }
    
    // Load files when browse button clicked
    browseFilesBtn.addEventListener('click', function() {
        loadFiles();
        fileBrowserModal.show();
    });
    
    function loadFiles() {
        fileListEl.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <div class="mt-2 text-muted">Loading files...</div>
            </div>
        `;
        
        fetch('{% url "list_commit_files" repository.id commit.id %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allFiles = data.files;
                    renderFileList(allFiles);
                } else {
                    fileListEl.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle me-2"></i>
                            ${data.error || 'Failed to load files'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                fileListEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle me-2"></i>
                        Failed to load files: ${error.message}
                    </div>
                `;
            });
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function renderFileList(files) {
        if (files.length === 0) {
            fileListEl.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="ti ti-folder-off" style="font-size: 2rem;"></i>
                    <div class="mt-2">No files found</div>
                </div>
            `;
            return;
        }
        
        const html = files.filter(f => f.type === 'file').map(file => {
            const escapedPath = escapeHtml(file.path);
            const escapedSize = escapeHtml(formatFileSize(file.size));
            return `
            <div class="list-group-item list-group-item-action cursor-pointer file-item" data-path="${escapedPath}">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <i class="ti ti-file-code text-muted"></i>
                    </div>
                    <div class="col">
                        <div class="text-truncate">${escapedPath}</div>
                        <small class="text-muted">${escapedSize}</small>
                    </div>
                    <div class="col-auto">
                        <i class="ti ti-chevron-right text-muted"></i>
                    </div>
                </div>
            </div>
        `}).join('');
        
        fileListEl.innerHTML = `<div class="list-group list-group-flush">${html}</div>`;
        
        // Add click handlers
        document.querySelectorAll('.file-item').forEach(item => {
            item.addEventListener('click', function() {
                const path = this.dataset.path;
                selectFile(path);
            });
        });
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    function selectFile(path) {
        dockerfilePathInput.value = path;
        fileBrowserModal.hide();
        loadFilePreview(path);
    }
    
    function loadFilePreview(path) {
        filePreviewSection.style.display = 'block';
        filePreviewEl.textContent = 'Loading...';
        
        fetch(`{% url "get_commit_file_content" repository.id commit.id %}?path=${encodeURIComponent(path)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    filePreviewEl.textContent = data.content;
                } else {
                    filePreviewEl.textContent = `Error: ${data.error || 'Failed to load file'}`;
                }
            })
            .catch(error => {
                filePreviewEl.textContent = `Error: ${error.message}`;
            });
    }
    
    // File search
    fileSearchEl.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const filtered = allFiles.filter(f => f.path.toLowerCase().includes(query));
        renderFileList(filtered);
    });
});
</script>
{% endblock %}
